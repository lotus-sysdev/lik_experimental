{% extends 'base.html' %} {% load auth_extras %} {% block title %}Item Data
Table{% endblock %} {% block content %} {% load static %}
<style>
  .custom-dropdown {
    background-color: royalblue;
    color: white;
    border-color: royalblue;
  }
</style>
<h1>Item List</h1>
<table
  id="itemTable"
  class="table table-bordered table-striped w-100 table-responsive-lg"
>
  <div class="form-inline mb-2">
    <select id="columnFilter" class="form-control btn-info">
      <option value="">Select Column</option>
      <option value="0">Upload Type</option>
      <option value="1">Tanggal Input</option>
      <option value="2">Tanggal Pesan</option>
      <option value="3">Customer</option>
      <option value="4">PIC</option>
      <option value="5">SKU</option>
      <option value="6">Nama</option>
      <option value="7">Category</option>
      <option value="8">Catatan</option>
      <option value="9">Quantity</option>
      <option value="10">Price</option>
      <option value="13">Approved</option>
      <!-- Tambahkan opsi lain jika diperlukan -->
    </select>
    <input
      type="text"
      id="columnSearch"
      placeholder="Search in selected column"
      class="form-control m-1"
      style="width: 30%"
    />
    <button id="searchButton" class="btn btn-primary mr-1">Search</button>
    <button id="resetButtonCol" class="btn btn-secondary mr-2">Reset</button>
    <button id="filterDuplicatesButton" class="btn btn-warning">
      Check Duplicates
    </button>
    <button id="resetFilterDuplicatesBtn" class="btn btn-secondary ml-1">
      Reset
    </button>
  </div>

  <div class="form-inline mb-2">
    <label class="mr-2" for="startDate">Start Date:</label>
    <input
      type="date"
      id="startDate"
      class="form-control mr-1"
      style="width: 15%"
    />
    <label class="mr-2" for="endDate">End Date:</label>
    <input
      type="date"
      id="endDate"
      class="form-control mr-1"
      style="width: 15%"
    />
    <button id="filterButton" class="btn btn-primary">Apply</button>
    <select id="dateRange" class="form-control ml-2 btn-info">
      <option value="">Select Date Range</option>
      <option value="7">Last 7 days</option>
      <option value="30">Last 30 days</option>
      <option value="60">Last 60 days</option>
      <option value="90">Last 90 days</option>
      <option value="ytd">Current year to date</option>
      <option value="365">Last 1 year (365 days)</option>
      <option value="730">Last 2 years (730 days)</option>
    </select>
    <button id="resetButton" class="btn btn-secondary ml-1">Reset</button>
  </div>

  <thead class="thead-light">
    {% csrf_token %}
    <tr>
      <th>Upload Type</th>
      <th>Tanggal Input</th>
      <th>Tanggal Pesan</th>
      <th>Customer</th>
      <th>PIC</th>
      <th>SKU</th>
      <th>Nama</th>
      <th>Catatan</th>
      <th>Category</th>
      <th>Quantity</th>
      <th>Price</th>
      <th>Gambar</th>
      <th>Link</th>
      <th>Status (Approve)</th>
      <th>Edit/Delete</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="exportPdfBtn" class="btn btn-primary">Export as PDF</button>

<a href="/add_item">Add Item</a><br />
<script src="https://cdn.datatables.net/select/3.0.0/js/dataTables.select.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.24/jspdf.plugin.autotable.min.js"></script>
<script>
    var table;
    function initializeDataTable() {
      var isAdmin = "{{ request.user|has_group:'Admin' }}";
      table = new DataTable("#itemTable", {
          processing: true,
          serverSide: true,
          ajax: {
              url: "{% url 'item_list' %}",
              type: "GET",
              data: function(d) {
                  // Add the extra filters from the frontend
                  d.start_date = $('#startDate').val();        // Start date filter
                  d.end_date = $('#endDate').val();            // End date filter
                  d.search_col = $('#columnFilter').val();  // Add search column
                  d.search_val = $('#columnSearch').val().trim();
              },
              dataSrc: function(json) {
                  // Log the JSON response to check if data is being received correctly
                  console.log(json);
                  return json.data;
              }
          },
          select: {
              style: "multi",
          },
          order: [[2, "desc"]],
          columnDefs: [
          {
              targets: 10,  // Price column
              render: function (data, type, row) {
                  if (type === "display") {
                      if (data.startsWith("IDR")) {
                          data = data
                              .replace(/,/g, "#")
                              .replace(/\./g, ",")
                              .replace(/#/g, ".");
                          data = data.substr(0, data.indexOf(",")); // Get substring until the first comma
                          data = data.substr(0, 3) + " " + data.substr(3);
                          return data;
                      } else if (data.startsWith("$")) {
                          data = data.replace("$", "USD");
                          data = data.substr(0, 3) + " " + data.substr(3);
                          return data;
                      } else {
                          return data.substr(0, 3) + " " + data.substr(3);
                      }
                  }
                  return data;
              },
          },
          {
              targets: [4],  // PIC column
              render: function (data, type, row, meta) {
                  if (type === "display") {
                      if (data && data.includes("-")) {
                          var picName = data.split("-")[1]; // Extract "John" part
                          return picName.trim(); // Return the trimmed name
                      } else {
                          return data; // Return the original data if it's null or doesn't contain a hyphen
                      }
                  }
                  return data;
              },
          },
          {
              targets: 13,  // "is_approved" column
              render: function (data, type, row) {
                  if (type === "display") {
                      return data === 'Yes' ? 'Yes' : 'No';
                  }
                  return data;
              },
          },
      ],
      columns: [
          { visible: false },  // upload_type
          { visible: false },  // Tanggal
          null,  // tanggal_pemesanan
          null,  // customer
          null,  // pic
          { visible: false },  // SKU
          { visible: true, width: "15%" },  // nama
          { visible: true, width: "20%" },  // catatan
          null,  // category
          null,  // quantity + unit
          { visible: true, width: "9%" },  // price
          null,  // gambar
          null,  // sumber URLs
          { visible: true, width: "9%" },  // is_approved
          null,  // detail_link
      ],
          createdRow: function(row, data, dataIndex) {
              if (data[13] === 'Yes') {  // Assuming the "is_approved" column is at index 13
                  $(row).css('background-color', '#ccffc7');  // Apply green background color
              }
          },
          lengthMenu: [
              [10, 25, 50, 100, -1],
              [10, 25, 50, 100, "All"],
          ],
          layout: {
            top2Start: {
              buttons: {
                buttons: [
                   {
                      text: "PDF",
                      extend: "print",
                      className: "btn-primary",
                      exportOptions: {
                          columns: ":visible", // Export only visible columns
                          stripHtml: false,
                      },

                  },
                  {
                      text: "Upload Excel",
                      className: "btn-secondary",
                      action: function () {
                          window.location.href = "/upload_excel";
                      },
                  },
                  {
                      text: "Delete Rows",
                      className: "btn-danger",
                      action: deleteSelectedRows,
                  },
                  {
                      extend: "copy",
                      text: "Copy",
                      className: "btn-warning",
                      header: false, // Disable export header tabla
                      exportOptions: {
                          columns: [6, 10], // Select columns to be exported
                      },
                      title: null,
                  },
                  {
                      text: "{% if request.user|has_group:'Admin' %} Approve {% endif %}",
                      className: "btn-success",
                      action: approveRows,
                      init: function (api, node, config) {
                          // Hide the button if the user is not in the Admin group
                          if (isAdmin === "False") {
                              $(node).addClass("d-none");
                          }
                      },
                  },
                  { extend: "colvis", className: "btn-info" },
                ],
                select: true,
                dom: {
                  button: {
                    className: "btn",
                  },
                },
              },
            },
          },
      });

     $("#exportPdfBtn").on("click", function () {
          var selectedData = table.rows({ selected: true }).data().toArray();
          var visibleColumns = [];
          var visibleColumnIndexes = [];

          // Ambil hanya kolom yang terlihat
          table.columns(":visible").every(function (index) {
              visibleColumns.push($(this.header()).text().trim());
              visibleColumnIndexes.push(index);
          });

          // Filter hanya kolom yang terlihat
          var filteredData = selectedData.map(row =>
              visibleColumnIndexes.map(index => row[index])
          );

          if (filteredData.length > 0 && visibleColumns.length > 0) {
              var csrfToken = $("input[name='csrfmiddlewaretoken']").val(); // Ambil CSRF token dari halaman

              $.ajax({
                  url: "/export-pdf/",
                  type: "POST",
                  headers: { "X-CSRFToken": csrfToken }, // Tambahkan CSRF token di header
                  data: JSON.stringify({
                      data: filteredData,
                      columns: visibleColumns,
                  }),
                  contentType: "application/json",
                  success: function (response) {
                      window.location.href = response.pdf_url;  // Arahkan ke halaman PDF
                  },
                  error: function (xhr, status, error) {
                      console.error("Export failed:", error);
                      alert("Gagal mengekspor PDF.");
                  }
              });
          } else {
              alert("Silakan pilih minimal satu baris untuk diekspor.");
          }
      });






    }

    {% comment %} function exportPDFWithLogo(table) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Add logo
      const logoUrl = "{% static 'image/header.png' %}";  // Replace with the URL or path to your logo
      const logoWidth = 50;  // Width of the logo
      const logoHeight = 20; // Height of the logo
      const pageWidth = doc.internal.pageSize.width;  // Get the page width
      const logoX = (pageWidth - logoWidth) / 2;  // Calculate center position



      // Add the logo to the top-center of the page
      doc.addImage(logoUrl, 'PNG', logoX, 10, logoWidth, logoHeight);

      // Add title
      doc.setFontSize(16);

      // Get selected rows
      const selectedRows = table.rows({ selected: true }).data();


      const selectedRowData = [];
      selectedRows.each(function(rowData) {
          const row = [];
          rowData.forEach(function(cellData) {
              row.push(cellData); // Add each cell's data to the row
          });
          selectedRowData.push(row);
      });

      console.log(selectedRows);

      // Get visible columns
      const visibleColumns = [];
      table.columns().every(function(index) {
          if (this.visible()) {
              visibleColumns.push(index);  // Store the index of visible columns
          }
      });

      console.log(table)

      // Get column headers dynamically from DataTable for visible columns
      const headers = [];
      visibleColumns.forEach(function(colIndex) {
          const headerText = table.column(colIndex).header().textContent.trim();
          headers.push(headerText); // Add the header text for visible columns
      });

      // Define column widths (adjust based on your specific needs)
      const columnWidths = visibleColumns.map((colIndex) => {
          if (colIndex === 6) {
              return 30; // Example for name column
          }
          if (colIndex === 10) {
              return 20; // Example for price column
          }
          return 30; // Default width for other columns
      });

      // Format data (for example, format price values or date)
      const formattedRowData = selectedRowData.map(function(rowData) {
          return visibleColumns.map(function(colIndex) {
              let value = rowData[colIndex];
              if (colIndex === 10) { // Assuming price is in column 10
                  // Format price values (e.g., add currency symbol and format)
                  if (typeof value === 'string' && value.startsWith("IDR")) {
                      value = value.replace(/,/g, "#").replace(/\./g, ",").replace(/#/g, ".");
                      return value;  // You can modify this further if needed
                  } else if (typeof value === 'string' && value.startsWith("$")) {
                      value = value.replace("$", "USD");
                      return value;
                  }
              }
              return value;
          });
      });

      // Use jsPDF's autoTable plugin to generate the table in the PDF
      doc.autoTable({
          head: [headers],
          body: formattedRowData,
          startY: 40,  // Position below the logo
          theme: 'grid',
          margin: { top: 30, left: 20, right: 20 },
          columnStyles: {
              0: { cellWidth: 10 }, // Example: Adjust column width for column 0
              1: { cellWidth: 25 }, // Example: Adjust column width for column 1
              6: { cellWidth: 30 }, // Adjust name column width
              10: { cellWidth: 20 }, // Adjust price column width
              // Add more column widths as needed
          },
      });

      // Save PDF with a custom name
      doc.save('datatable_report_with_logo.pdf');
  } {% endcomment %}




    function deleteSelectedRows() {
      if (!table) {
        console.error("Table is not initialized.");
        return;
      }
      var selectedIDs = table
        .rows(".selected")
        .data()
        .toArray()
        .map(function (row) {
          return row[5];
        });
      if (selectedIDs.length === 0) {
        alert("Please select at least one row to delete.");
        return;
      }
      if (confirm("Are you sure you want to delete the selected rows?")) {
        var csrfToken = document.getElementsByName("csrfmiddlewaretoken")[0]
          .value;
        $.ajax({
          url: '{% url "delete_selected_rows_item" %}',
          type: "POST",
          data: { selected_ids: selectedIDs, csrfmiddlewaretoken: csrfToken },
          dataType: "json",
          success: function (response) {
            if (response.success) {
              alert("Selected rows deleted successfully.");
              location.reload();
            } else {
              alert("Error deleting selected rows: " + response.error);
            }
          },
          error: function (xhr, status, error) {
            alert("Error deleting selected rows: " + error);
          },
        });
      }
    }

    function approveRows() {
      if (!table) {
        console.error("Table is not initialized.");
        return;
      }
      var selectedIDs = table
        .rows(".selected")
        .data()
        .toArray()
        .map(function (row) {
          return row[5];
        });
      if (selectedIDs.length === 0) {
        alert("Please select at least one row to approve.");
        return;
      }
      if (confirm("Are you sure you want to approve the selected rows?")) {
        var csrfToken = document.getElementsByName("csrfmiddlewaretoken")[0]
          .value;
        $.ajax({
          url: '{% url "approve_selected_rows" %}',
          type: "POST",
          data: { selected_ids: selectedIDs, csrfmiddlewaretoken: csrfToken },
          dataType: "json",
          success: function (response) {
            if (response.success) {
              alert("Selected rows approved successfully.");
              location.reload();
            } else {
              alert("Error approving selected rows: " + response.error);
            }
          },
          error: function (xhr, status, error) {
            alert("Error approving selected rows: " + error);
          },
        });
      }
    }

    $(document).ready(function () {
      initializeDataTable();

      $("#startDate").val("");
      $("#endDate").val("");

      $("#searchButton")
        .off("click")
        .on("click", function () {
          console.log("Search clicked. Value:", $("#columnSearch").val());
          table.ajax.reload();
        });

      $("#columnSearch").on("keypress", function (e) {
        if (e.which === 13) {
          table.ajax.reload();
        }
      });

      $("#resetFilterDuplicatesBtn").on("click", function () {
        resetFilterDuplicates();
      });
      // Trigger search on button click
      $("#searchButton").on("click", function () {
        // columnSearch();
        console.log("Search column:", $('#columnFilter').val());
        console.log("Search value:", $('#columnSearch').val());

        table.ajax.reload();
      });

      // Reset search on button click
      $("#resetButtonCol").on("click", function () {
        resetSearch();
      });

      // Function to perform column-specific search
      function columnSearch() {
          var columnIndex = $("#columnFilter").val(); // Get the index of the selected column
          var searchValue = $("#columnSearch").val().trim(); // Get the value of the search input

          // Reload the DataTable with the new search parameters
          table.ajax.reload(null, false, function (settings, json) {
              // Add the search_column and search_value to the request
              settings.ajax.data.search_column = columnIndex;
              settings.ajax.data.search_value = searchValue;
          });
      }
      // Function to reset check duplicates button
      function resetFilterDuplicates() {
        // Show all rows
        table.rows().nodes().to$().show();

        table.draw();
      }

      // Function to reset search
      function resetSearch() {
        $("#columnSearch").val(""); // Clear the search input
        table.search("").columns().search("").draw(); // Clear all column-specific searches and redraw the table
      }

      $("#filterButton").click(function () {
        var startDate = $("#startDate").val();
        var endDate = $("#endDate").val();
        filterByDateRange(startDate, endDate);
      });

      $("#resetButton")
        .off("click")
        .on("click", function () {
          $("#startDate").val("");
          $("#endDate").val("");
          $("#dateRange").val("");
          $("#columnSearch").val("");
          table.ajax.reload();
        });

      $("#dateRange")
        .off("change")
        .on("change", function () {
          var dateRange = $(this).val();
          var startDate = "";
          var endDate = "";
          if (dateRange === "7") {
            endDate = formatDate(new Date());
            startDate = formatDate(
              new Date(new Date().setDate(new Date().getDate() - 6))
            );
          } else if (dateRange === "30") {
            endDate = formatDate(new Date());
            startDate = formatDate(
              new Date(new Date().setDate(new Date().getDate() - 29))
            );
          } else if (dateRange === "60") {
            endDate = formatDate(new Date());
            startDate = formatDate(
              new Date(new Date().setDate(new Date().getDate() - 59))
            );
          } else if (dateRange === "90") {
            endDate = formatDate(new Date());
            startDate = formatDate(
              new Date(new Date().setDate(new Date().getDate() - 89))
            );
          } else if (dateRange === "365") {
            endDate = formatDate(new Date());
            startDate = formatDate(
              new Date(new Date().setDate(new Date().getDate() - 364))
            );
          } else if (dateRange === "730") {
            endDate = formatDate(new Date());
            startDate = formatDate(
              new Date(new Date().setDate(new Date().getDate() - 729))
            );
          } else if (dateRange === "ytd") {
            endDate = formatDate(new Date());
            startDate = formatDate(new Date(new Date().getFullYear(), 0, 1));
          }
          $("#startDate").val(startDate);
          $("#endDate").val(endDate);
          table.ajax.reload();
        });

      function formatDate(date) {
        var year = date.getFullYear();
        var month = ("0" + (date.getMonth() + 1)).slice(-2);
        var day = ("0" + date.getDate()).slice(-2);
        return year + "-" + month + "-" + day;
      }

      function filterByDateRange(startDate, endDate) {
        $("#startDate").val(startDate);
        $("#endDate").val(endDate);
        table.ajax.reload();
      }
    });
</script>
{% endblock %}
